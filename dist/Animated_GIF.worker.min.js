function NeuQuant(){function r(r,n,t){var a,e;for(s=r,h=n,l=t,p=new Array(y),a=0;y>a;a++)p[a]=new Array(4),e=p[a],e[0]=e[1]=e[2]=(a<<x+8)/y|0,J[a]=G/y|0,H[a]=0}function n(){for(var r=[],n=new Array(y),t=0;y>t;t++)n[p[t][3]]=t;for(var a=0,e=0;y>e;e++){var f=n[e];r[a++]=p[f][0],r[a++]=p[f][1],r[a++]=p[f][2]}return r}function t(){var r,n,t,a,e,f,o,u;for(o=0,u=0,r=0;y>r;r++){for(e=p[r],t=r,a=e[1],n=r+1;y>n;n++)f=p[n],f[1]<a&&(t=n,a=f[1]);if(f=p[t],r!=t&&(n=f[0],f[0]=e[0],e[0]=n,n=f[1],f[1]=e[1],e[1]=n,n=f[2],f[2]=e[2],e[2]=n,n=f[3],f[3]=e[3],e[3]=n),a!=o){for(F[o]=u+r>>1,n=o+1;a>n;n++)F[n]=r;o=a,u=r}}for(F[o]=u+B>>1,n=o+1;256>n;n++)F[n]=B}function a(){var r,n,t,a,e,f,o,p,y,B,D,G,P,R;for(m>h&&(l=1),v=30+(l-1)/3,G=s,P=0,R=h,D=h/(3*l),B=D/z|0,p=O,f=I,o=f>>j,1>=o&&(o=0),r=0;o>r;r++)K[r]=p*((o*o-r*r)*q/(o*o));for(y=m>h?3:h%g!==0?3*g:h%w!==0?3*w:h%d!==0?3*d:3*A,r=0;D>r;)if(t=(255&G[P+0])<<x,a=(255&G[P+1])<<x,e=(255&G[P+2])<<x,n=c(t,a,e),i(p,n,t,a,e),0!==o&&u(o,n,t,a,e),P+=y,P>=R&&(P-=h),r++,0===B&&(B=1),r%B===0)for(p-=p/v,f-=f/M,o=f>>j,1>=o&&(o=0),n=0;o>n;n++)K[n]=p*((o*o-n*n)*q/(o*o))}function e(r,n,t){var a,e,f,o,u,i,c;for(u=1e3,c=-1,a=F[n],e=a-1;y>a||e>=0;)y>a&&(i=p[a],f=i[1]-n,f>=u?a=y:(a++,0>f&&(f=-f),o=i[0]-r,0>o&&(o=-o),f+=o,u>f&&(o=i[2]-t,0>o&&(o=-o),f+=o,u>f&&(u=f,c=i[3])))),e>=0&&(i=p[e],f=n-i[1],f>=u?e=-1:(e--,0>f&&(f=-f),o=i[0]-r,0>o&&(o=-o),f+=o,u>f&&(o=i[2]-t,0>o&&(o=-o),f+=o,u>f&&(u=f,c=i[3]))));return c}function f(){return a(),o(),t(),n()}function o(){var r;for(r=0;y>r;r++)p[r][0]>>=x,p[r][1]>>=x,p[r][2]>>=x,p[r][3]=r}function u(r,n,t,a,e){var f,o,u,i,c,v,s;for(u=n-r,-1>u&&(u=-1),i=n+r,i>y&&(i=y),f=n+1,o=n-1,v=1;i>f||o>u;){if(c=K[v++],i>f){s=p[f++];try{s[0]-=c*(s[0]-t)/E|0,s[1]-=c*(s[1]-a)/E|0,s[2]-=c*(s[2]-e)/E|0}catch(h){}}if(o>u){s=p[o--];try{s[0]-=c*(s[0]-t)/E|0,s[1]-=c*(s[1]-a)/E|0,s[2]-=c*(s[2]-e)/E|0}catch(h){}}}}function i(r,n,t,a,e){var f=p[n],o=r/O;f[0]-=o*(f[0]-t)|0,f[1]-=o*(f[1]-a)|0,f[2]-=o*(f[2]-e)|0}function c(r,n,t){var a,e,f,o,u,i,c,v,s,h;for(v=~(1<<31),s=v,i=-1,c=i,a=0;y>a;a++)h=p[a],e=h[0]-r,0>e&&(e=-e),f=h[1]-n,0>f&&(f=-f),e+=f,f=h[2]-t,0>f&&(f=-f),e+=f,v>e&&(v=e,i=a),o=e-(H[a]>>D-x),s>o&&(s=o,c=a),u=J[a]>>R,J[a]-=u,H[a]+=u<<P;return J[i]+=T,H[i]-=U,c}var v,s,h,l,p,y=256,g=499,w=491,d=487,A=503,m=3*A,B=y-1,x=4,z=100,D=16,G=1<<D,P=10,R=10,T=G>>R,U=G<<P-R,b=y>>3,j=6,k=1<<j,I=b*k,M=30,N=10,O=1<<N,Q=8,q=1<<Q,C=N+Q,E=1<<C,F=[],H=[],J=[],K=[];r.apply(this,arguments);var L={};return L.map=e,L.process=f,L}function channelizePalette(r){for(var n=[],t=0;t<r.length;t++){var a=r[t],e=(16711680&a)>>16,f=(65280&a)>>8,o=255&a;n.push([e,f,o,a])}return n}function dataToRGB(r,n,t){for(var a=0,e=n*t*4,f=[];e>a;)f.push(r[a++]),f.push(r[a++]),f.push(r[a++]),a++;return f}function run(r){var n=r.data,t=r.width,a=r.height,e=(Object.keys(n).length,r.sampleInterval,dataToRGB(n,t,a)),f=[4278190080,4294967295],o=new Uint32Array(f),u=channelizePalette(f);return pixels=Dithering.Bayer(e,t,a,u),{pixels:pixels,palette:o}}var Dithering=function(){function r(r){return 0>r?0:r>255?255:r}function n(r,n,t,a,e){for(var f,o,u,i,c,v=195076,s=0,h=0;e>h;h++)c=a[h],f=r-c[0],o=n-c[1],u=t-c[2],i=f*f+o*o+u*u,v>i&&(s=h,v=i);return s}function t(t,e,f,o){for(var u,i,c,v,s,h=0,l=0,p=o.length,y=a,g=new Uint8Array(e*f),w=8,d=8,A=0;f>A;A++)for(var m=A%d,B=0;e>B;B++)v=y[B%w][m],u=r(t[h++]+v),i=r(t[h++]+v),c=r(t[h++]+v),s=n(u,i,c,o,p),g[l++]=s;return g}var a=[[1,49,13,61,4,52,16,64],[33,17,45,29,36,20,48,32],[9,57,5,53,12,60,8,56],[41,25,37,21,44,28,40,24],[3,51,15,63,2,50,14,62],[35,19,47,31,34,18,46,30],[11,59,7,55,10,58,6,54],[43,27,39,23,42,26,38,22]];return{Bayer:t}}();self.onmessage=function(r){var n=r.data,t=run(n);postMessage(t)};