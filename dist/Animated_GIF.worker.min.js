function NeuQuant(){function r(r,n,e){var t,a;for(l=r,h=n,p=e,v=new Array(g),t=0;g>t;t++)v[t]=new Array(4),a=v[t],a[0]=a[1]=a[2]=(t<<x+8)/g|0,J[t]=P/g|0,H[t]=0}function n(){for(var r=[],n=new Array(g),e=0;g>e;e++)n[v[e][3]]=e;for(var t=0,a=0;g>a;a++){var i=n[a];r[t++]=v[i][0],r[t++]=v[i][1],r[t++]=v[i][2]}return r}function e(){var r,n,e,t,a,i,o,u;for(o=0,u=0,r=0;g>r;r++){for(a=v[r],e=r,t=a[1],n=r+1;g>n;n++)i=v[n],i[1]<t&&(e=n,t=i[1]);if(i=v[e],r!=e&&(n=i[0],i[0]=a[0],a[0]=n,n=i[1],i[1]=a[1],a[1]=n,n=i[2],i[2]=a[2],a[2]=n,n=i[3],i[3]=a[3],a[3]=n),t!=o){for(E[o]=u+r>>1,n=o+1;t>n;n++)E[n]=r;o=t,u=r}}for(E[o]=u+z>>1,n=o+1;256>n;n++)E[n]=z}function t(){var r,n,e,t,a,i,o,v,g,z,T,P,Q,D;for(A>h&&(p=1),s=30+(p-1)/3,P=l,Q=0,D=h,T=h/(3*p),z=T/B|0,v=M,i=W,o=i>>N,1>=o&&(o=0),r=0;o>r;r++)K[r]=v*((o*o-r*r)*k/(o*o));for(g=A>h?3:h%y!==0?3*y:h%d!==0?3*d:h%m!==0?3*m:3*w,r=0;T>r;)if(e=(255&P[Q+0])<<x,t=(255&P[Q+1])<<x,a=(255&P[Q+2])<<x,n=c(e,t,a),f(v,n,e,t,a),0!==o&&u(o,n,e,t,a),Q+=g,Q>=D&&(Q-=h),r++,0===z&&(z=1),r%z===0)for(v-=v/s,i-=i/b,o=i>>N,1>=o&&(o=0),n=0;o>n;n++)K[n]=v*((o*o-n*n)*k/(o*o))}function a(r,n,e){var t,a,i,o,u,f,c;for(u=1e3,c=-1,t=E[n],a=t-1;g>t||a>=0;)g>t&&(f=v[t],i=f[1]-n,i>=u?t=g:(t++,0>i&&(i=-i),o=f[0]-r,0>o&&(o=-o),i+=o,u>i&&(o=f[2]-e,0>o&&(o=-o),i+=o,u>i&&(u=i,c=f[3])))),a>=0&&(f=v[a],i=n-f[1],i>=u?a=-1:(a--,0>i&&(i=-i),o=f[0]-r,0>o&&(o=-o),i+=o,u>i&&(o=f[2]-e,0>o&&(o=-o),i+=o,u>i&&(u=i,c=f[3]))));return c}function i(){return t(),o(),e(),n()}function o(){var r;for(r=0;g>r;r++)v[r][0]>>=x,v[r][1]>>=x,v[r][2]>>=x,v[r][3]=r}function u(r,n,e,t,a){var i,o,u,f,c,s,l;for(u=n-r,-1>u&&(u=-1),f=n+r,f>g&&(f=g),i=n+1,o=n-1,s=1;f>i||o>u;){if(c=K[s++],f>i){l=v[i++];try{l[0]-=c*(l[0]-e)/C|0,l[1]-=c*(l[1]-t)/C|0,l[2]-=c*(l[2]-a)/C|0}catch(h){}}if(o>u){l=v[o--];try{l[0]-=c*(l[0]-e)/C|0,l[1]-=c*(l[1]-t)/C|0,l[2]-=c*(l[2]-a)/C|0}catch(h){}}}}function f(r,n,e,t,a){var i=v[n],o=r/M;i[0]-=o*(i[0]-e)|0,i[1]-=o*(i[1]-t)|0,i[2]-=o*(i[2]-a)|0}function c(r,n,e){var t,a,i,o,u,f,c,s,l,h;for(s=~(1<<31),l=s,f=-1,c=f,t=0;g>t;t++)h=v[t],a=h[0]-r,0>a&&(a=-a),i=h[1]-n,0>i&&(i=-i),a+=i,i=h[2]-e,0>i&&(i=-i),a+=i,s>a&&(s=a,f=t),o=a-(H[t]>>T-x),l>o&&(l=o,c=t),u=J[t]>>D,J[t]-=u,H[t]+=u<<Q;return J[f]+=U,H[f]-=F,c}var s,l,h,p,v,g=256,y=499,d=491,m=487,w=503,A=3*w,z=g-1,x=4,B=100,T=16,P=1<<T,Q=10,D=10,U=P>>D,F=P<<Q-D,G=g>>3,N=6,R=1<<N,W=G*R,b=30,I=10,M=1<<I,j=8,k=1<<j,q=I+j,C=1<<q,E=[],H=[],J=[],K=[];r.apply(this,arguments);var L={};return L.map=a,L.process=i,L}function channelizePalette(r){for(var n=[],e=0;e<r.length;e++){var t=r[e],a=(16711680&t)>>16,i=(65280&t)>>8,o=255&t;n.push([a,i,o,t])}return n}function dataToRGB(r,n,e){for(var t=0,a=n*e*4,i=[];a>t;)i.push(r[t++]),i.push(r[t++]),i.push(r[t++]),t++;return i}function componentizedPaletteToArray(r){for(var n=[],e=0;e<r.length;e+=3){var t=r[e],a=r[e+1],i=r[e+2];n.push(t<<16|a<<8|i)}return n}function processFrameWithQuantizer(n,e,t,a){for(var i=dataToRGB(n,e,t),o=new NeuQuant(i,i.length,a),u=o.process(),f=new Uint32Array(componentizedPaletteToArray(u)),c=e*t,s=new Uint8Array(c),l=0,h=0;c>h;h++)r=i[l++],g=i[l++],b=i[l++],s[h]=o.map(r,g,b);return{pixels:s,palette:f}}function processFrameWithDithering(r,n,e,t,a){var i=dataToRGB(r,n,e);if(null===a){var o=new NeuQuant(i,i.length,16),u=o.process();a=componentizedPaletteToArray(u)}var f=new Uint32Array(a),c=channelizePalette(a);return pixels=Dithering.Bayer(i,n,e,c),{pixels:pixels,palette:f}}function run(r){var n=r.width,e=r.height,t=r.data,a=r.dithering,i=r.palette,o=r.sampleInterval;return a?processFrameWithDithering(t,n,e,a,i):processFrameWithQuantizer(t,n,e,o)}function run2(r){var n,e,t,a=r.data,i=r.width,o=r.height,u=r.palette,f=(r.dithering,r.sampleInterval),c=dataToRGB(a,i,o);if(null===u){var s=new NeuQuant(c,c.length,f),l=s.process();u=[];for(var h=0;h<l.length;h+=3)n=l[h],e=l[h+1],t=l[h+2],u.push(n<<16|e<<8|t)}var p=new Uint32Array(u),v=channelizePalette(u);return pixels=Dithering.Bayer(c,i,o,v),{pixels:pixels,palette:p}}var Dithering=function(){function r(r){return 0>r?0:r>255?255:r}function n(r,n,e,t,a){for(var i,o,u,f,c,s=195076,l=0,h=0;a>h;h++)c=t[h],i=r-c[0],o=n-c[1],u=e-c[2],f=i*i+o*o+u*u,s>f&&(l=h,s=f);return l}function e(e,a,i,o){for(var u,f,c,s,l,h=0,p=0,v=o.length,g=t,y=new Uint8Array(a*i),d=8,m=8,w=0;i>w;w++)for(var A=w%m,z=0;a>z;z++)s=g[z%d][A],u=r(e[h++]+s),f=r(e[h++]+s),c=r(e[h++]+s),l=n(u,f,c,o,v),y[p++]=l;return y}var t=[[1,49,13,61,4,52,16,64],[33,17,45,29,36,20,48,32],[9,57,5,53,12,60,8,56],[41,25,37,21,44,28,40,24],[3,51,15,63,2,50,14,62],[35,19,47,31,34,18,46,30],[11,59,7,55,10,58,6,54],[43,27,39,23,42,26,38,22]];return{Bayer:e}}();self.onmessage=function(r){var n=r.data,e=run(n);postMessage(e)};