function NeuQuant(){function r(r,n,t){var e,a;for(v=r,h=n,l=t,p=new Array(g),e=0;g>e;e++)p[e]=new Array(4),a=p[e],a[0]=a[1]=a[2]=(e<<T+8)/g|0,J[e]=P/g|0,H[e]=0}function n(){for(var r=[],n=new Array(g),t=0;g>t;t++)n[p[t][3]]=t;for(var e=0,a=0;g>a;a++){var o=n[a];r[e++]=p[o][0],r[e++]=p[o][1],r[e++]=p[o][2]}return r}function t(){var r,n,t,e,a,o,i,u;for(i=0,u=0,r=0;g>r;r++){for(a=p[r],t=r,e=a[1],n=r+1;g>n;n++)o=p[n],o[1]<e&&(t=n,e=o[1]);if(o=p[t],r!=t&&(n=o[0],o[0]=a[0],a[0]=n,n=o[1],o[1]=a[1],a[1]=n,n=o[2],o[2]=a[2],a[2]=n,n=o[3],o[3]=a[3],a[3]=n),e!=i){for(E[i]=u+r>>1,n=i+1;e>n;n++)E[n]=r;i=e,u=r}}for(E[i]=u+z>>1,n=i+1;256>n;n++)E[n]=z}function e(){var r,n,t,e,a,o,i,p,g,z,D,P,Q,U;for(d>h&&(l=1),s=30+(l-1)/3,P=v,Q=0,U=h,D=h/(3*l),z=D/B|0,p=I,o=R,i=o>>G,1>=i&&(i=0),r=0;i>r;r++)K[r]=p*((i*i-r*r)*j/(i*i));for(g=d>h?3:h%y!==0?3*y:h%m!==0?3*m:h%w!==0?3*w:3*A,r=0;D>r;)if(t=(255&P[Q+0])<<T,e=(255&P[Q+1])<<T,a=(255&P[Q+2])<<T,n=c(t,e,a),f(p,n,t,e,a),0!==i&&u(i,n,t,e,a),Q+=g,Q>=U&&(Q-=h),r++,0===z&&(z=1),r%z===0)for(p-=p/s,o-=o/b,i=o>>G,1>=i&&(i=0),n=0;i>n;n++)K[n]=p*((i*i-n*n)*j/(i*i))}function a(r,n,t){var e,a,o,i,u,f,c;for(u=1e3,c=-1,e=E[n],a=e-1;g>e||a>=0;)g>e&&(f=p[e],o=f[1]-n,o>=u?e=g:(e++,0>o&&(o=-o),i=f[0]-r,0>i&&(i=-i),o+=i,u>o&&(i=f[2]-t,0>i&&(i=-i),o+=i,u>o&&(u=o,c=f[3])))),a>=0&&(f=p[a],o=n-f[1],o>=u?a=-1:(a--,0>o&&(o=-o),i=f[0]-r,0>i&&(i=-i),o+=i,u>o&&(i=f[2]-t,0>i&&(i=-i),o+=i,u>o&&(u=o,c=f[3]))));return c}function o(){return e(),i(),t(),n()}function i(){var r;for(r=0;g>r;r++)p[r][0]>>=T,p[r][1]>>=T,p[r][2]>>=T,p[r][3]=r}function u(r,n,t,e,a){var o,i,u,f,c,s,v;for(u=n-r,-1>u&&(u=-1),f=n+r,f>g&&(f=g),o=n+1,i=n-1,s=1;f>o||i>u;){if(c=K[s++],f>o){v=p[o++];try{v[0]-=c*(v[0]-t)/q|0,v[1]-=c*(v[1]-e)/q|0,v[2]-=c*(v[2]-a)/q|0}catch(h){}}if(i>u){v=p[i--];try{v[0]-=c*(v[0]-t)/q|0,v[1]-=c*(v[1]-e)/q|0,v[2]-=c*(v[2]-a)/q|0}catch(h){}}}}function f(r,n,t,e,a){var o=p[n],i=r/I;o[0]-=i*(o[0]-t)|0,o[1]-=i*(o[1]-e)|0,o[2]-=i*(o[2]-a)|0}function c(r,n,t){var e,a,o,i,u,f,c,s,v,h;for(s=~(1<<31),v=s,f=-1,c=f,e=0;g>e;e++)h=p[e],a=h[0]-r,0>a&&(a=-a),o=h[1]-n,0>o&&(o=-o),a+=o,o=h[2]-t,0>o&&(o=-o),a+=o,s>a&&(s=a,f=e),i=a-(H[e]>>D-T),v>i&&(v=i,c=e),u=J[e]>>U,J[e]-=u,H[e]+=u<<Q;return J[f]+=x,H[f]-=F,c}var s,v,h,l,p,g=256,y=499,m=491,w=487,A=503,d=3*A,z=g-1,T=4,B=100,D=16,P=1<<D,Q=10,U=10,x=P>>U,F=P<<Q-U,W=g>>3,G=6,N=1<<G,R=W*N,b=30,C=10,I=1<<C,M=8,j=1<<M,k=C+M,q=1<<k,E=[],H=[],J=[],K=[];r.apply(this,arguments);var L={};return L.map=a,L.process=o,L}function channelizePalette(r){for(var n=[],t=0;t<r.length;t++){var e=r[t],a=(16711680&e)>>16,o=(65280&e)>>8,i=255&e;n.push([a,o,i,e])}return n}function dataToRGB(r,n,t){for(var e=0,a=n*t*4,o=[];a>e;)o.push(r[e++]),o.push(r[e++]),o.push(r[e++]),e++;return o}function componentizedPaletteToArray(r){for(var n=[],t=0;t<r.length;t+=3){var e=r[t],a=r[t+1],o=r[t+2];n.push(e<<16|a<<8|o)}return n}function processFrameWithQuantizer(n,t,e,a){for(var o=dataToRGB(n,t,e),i=new NeuQuant(o,o.length,a),u=i.process(),f=new Uint32Array(componentizedPaletteToArray(u)),c=t*e,s=new Uint8Array(c),v=0,h=0;c>h;h++)r=o[v++],g=o[v++],b=o[v++],s[h]=i.map(r,g,b);return{pixels:s,palette:f}}function processFrameWithDithering(r,n,t,e,a){var o=dataToRGB(r,n,t);if(null===a){var i=new NeuQuant(o,o.length,16),u=i.process();a=componentizedPaletteToArray(u)}var f,c=new Uint32Array(a),s=channelizePalette(a);return f="closest"===e?Dithering.Closest:Dithering.Bayer,pixels=f(o,n,t,s),{pixels:pixels,palette:c}}function run(r){var n=r.width,t=r.height,e=r.data,a=r.dithering,o=r.palette,i=r.sampleInterval;return a?processFrameWithDithering(e,n,t,a,o):processFrameWithQuantizer(e,n,t,i)}var Dithering=function(){"use strict";function r(r){return 0>r?0:r>255?255:r}function n(r,n,t,e,a){for(var o,i,u,f,c,s=195076,v=0,h=0;a>h;h++)c=e[h],o=r-c[0],i=n-c[1],u=t-c[2],f=o*o+i*i+u*u,s>f&&(v=h,s=f);return v}function t(t,e,o,i){for(var u,f,c,s,v,h=0,l=0,p=i.length,g=a,y=new Uint8Array(e*o),m=8,w=8,A=0;o>A;A++)for(var d=A%w,z=0;e>z;z++)s=g[z%m][d],u=r(t[h++]+s),f=r(t[h++]+s),c=r(t[h++]+s),v=n(u,f,c,i,p),y[l++]=v;return y}function e(r,t,e,a){for(var o,i,u,f=0,c=a.length,s=t*e,v=new Uint8Array(s),h=0;s>h;h++)o=r[f++],i=r[f++],u=r[f++],v[h]=n(o,i,u,a,c);return v}var a=[[1,49,13,61,4,52,16,64],[33,17,45,29,36,20,48,32],[9,57,5,53,12,60,8,56],[41,25,37,21,44,28,40,24],[3,51,15,63,2,50,14,62],[35,19,47,31,34,18,46,30],[11,59,7,55,10,58,6,54],[43,27,39,23,42,26,38,22]];return{Bayer:t,Closest:e}}();self.onmessage=function(r){var n=r.data,t=run(n);postMessage(t)};