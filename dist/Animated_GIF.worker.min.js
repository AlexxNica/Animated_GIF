function NeuQuant(){function r(r,n,t){var e,a;for(v=r,p=n,h=t,l=new Array(g),e=0;g>e;e++)l[e]=new Array(4),a=l[e],a[0]=a[1]=a[2]=(e<<T+8)/g|0,J[e]=Q/g|0,H[e]=0}function n(){for(var r=[],n=new Array(g),t=0;g>t;t++)n[l[t][3]]=t;for(var e=0,a=0;g>a;a++){var o=n[a];r[e++]=l[o][0],r[e++]=l[o][1],r[e++]=l[o][2]}return r}function t(){var r,n,t,e,a,o,i,u;for(i=0,u=0,r=0;g>r;r++){for(a=l[r],t=r,e=a[1],n=r+1;g>n;n++)o=l[n],o[1]<e&&(t=n,e=o[1]);if(o=l[t],r!=t&&(n=o[0],o[0]=a[0],a[0]=n,n=o[1],o[1]=a[1],a[1]=n,n=o[2],o[2]=a[2],a[2]=n,n=o[3],o[3]=a[3],a[3]=n),e!=i){for(E[i]=u+r>>1,n=i+1;e>n;n++)E[n]=r;i=e,u=r}}for(E[i]=u+z>>1,n=i+1;256>n;n++)E[n]=z}function e(){var r,n,t,e,a,o,i,l,g,z,P,Q,x,D;for(A>p&&(h=1),s=30+(h-1)/3,Q=v,x=0,D=p,P=p/(3*h),z=P/B|0,l=M,o=R,i=o>>G,1>=i&&(i=0),r=0;i>r;r++)K[r]=l*((i*i-r*r)*k/(i*i));for(g=A>p?3:p%y!==0?3*y:p%m!==0?3*m:p%d!==0?3*d:3*w,r=0;P>r;)if(t=(255&Q[x+0])<<T,e=(255&Q[x+1])<<T,a=(255&Q[x+2])<<T,n=c(t,e,a),f(l,n,t,e,a),0!==i&&u(i,n,t,e,a),x+=g,x>=D&&(x-=p),r++,0===z&&(z=1),r%z===0)for(l-=l/s,o-=o/b,i=o>>G,1>=i&&(i=0),n=0;i>n;n++)K[n]=l*((i*i-n*n)*k/(i*i))}function a(r,n,t){var e,a,o,i,u,f,c;for(u=1e3,c=-1,e=E[n],a=e-1;g>e||a>=0;)g>e&&(f=l[e],o=f[1]-n,o>=u?e=g:(e++,0>o&&(o=-o),i=f[0]-r,0>i&&(i=-i),o+=i,u>o&&(i=f[2]-t,0>i&&(i=-i),o+=i,u>o&&(u=o,c=f[3])))),a>=0&&(f=l[a],o=n-f[1],o>=u?a=-1:(a--,0>o&&(o=-o),i=f[0]-r,0>i&&(i=-i),o+=i,u>o&&(i=f[2]-t,0>i&&(i=-i),o+=i,u>o&&(u=o,c=f[3]))));return c}function o(){return e(),i(),t(),n()}function i(){var r;for(r=0;g>r;r++)l[r][0]>>=T,l[r][1]>>=T,l[r][2]>>=T,l[r][3]=r}function u(r,n,t,e,a){var o,i,u,f,c,s,v;for(u=n-r,-1>u&&(u=-1),f=n+r,f>g&&(f=g),o=n+1,i=n-1,s=1;f>o||i>u;){if(c=K[s++],f>o){v=l[o++];try{v[0]-=c*(v[0]-t)/C|0,v[1]-=c*(v[1]-e)/C|0,v[2]-=c*(v[2]-a)/C|0}catch(p){}}if(i>u){v=l[i--];try{v[0]-=c*(v[0]-t)/C|0,v[1]-=c*(v[1]-e)/C|0,v[2]-=c*(v[2]-a)/C|0}catch(p){}}}}function f(r,n,t,e,a){var o=l[n],i=r/M;o[0]-=i*(o[0]-t)|0,o[1]-=i*(o[1]-e)|0,o[2]-=i*(o[2]-a)|0}function c(r,n,t){var e,a,o,i,u,f,c,s,v,p;for(s=~(1<<31),v=s,f=-1,c=f,e=0;g>e;e++)p=l[e],a=p[0]-r,0>a&&(a=-a),o=p[1]-n,0>o&&(o=-o),a+=o,o=p[2]-t,0>o&&(o=-o),a+=o,s>a&&(s=a,f=e),i=a-(H[e]>>P-T),v>i&&(v=i,c=e),u=J[e]>>D,J[e]-=u,H[e]+=u<<x;return J[f]+=F,H[f]-=U,c}var s,v,p,h,l,g=256,y=499,m=491,d=487,w=503,A=3*w,z=g-1,T=4,B=100,P=16,Q=1<<P,x=10,D=10,F=Q>>D,U=Q<<x-D,W=g>>3,G=6,N=1<<G,R=W*N,b=30,I=10,M=1<<I,j=8,k=1<<j,q=I+j,C=1<<q,E=[],H=[],J=[],K=[];r.apply(this,arguments);var L={};return L.map=a,L.process=o,L}function channelizePalette(r){for(var n=[],t=0;t<r.length;t++){var e=r[t],a=(16711680&e)>>16,o=(65280&e)>>8,i=255&e;n.push([a,o,i,e])}return n}function dataToRGB(r,n,t){for(var e=0,a=n*t*4,o=[];a>e;)o.push(r[e++]),o.push(r[e++]),o.push(r[e++]),e++;return o}function componentizedPaletteToArray(r){for(var n=[],t=0;t<r.length;t+=3){var e=r[t],a=r[t+1],o=r[t+2];n.push(e<<16|a<<8|o)}return n}function processFrameWithQuantizer(n,t,e,a){for(var o=dataToRGB(n,t,e),i=new NeuQuant(o,o.length,a),u=i.process(),f=new Uint32Array(componentizedPaletteToArray(u)),c=t*e,s=new Uint8Array(c),v=0,p=0;c>p;p++)r=o[v++],g=o[v++],b=o[v++],s[p]=i.map(r,g,b);return{pixels:s,palette:f}}function processFrameWithDithering(r,n,t,e,a){var o=dataToRGB(r,n,t);if(null===a){var i=new NeuQuant(o,o.length,16),u=i.process();a=componentizedPaletteToArray(u)}var f=new Uint32Array(a),c=channelizePalette(a);return pixels=Dithering.Bayer(o,n,t,c),{pixels:pixels,palette:f}}function run(r){var n=r.width,t=r.height,e=r.data,a=r.dithering,o=r.palette,i=r.sampleInterval;return a?processFrameWithDithering(e,n,t,a,o):processFrameWithQuantizer(e,n,t,i)}var Dithering=function(){function r(r){return 0>r?0:r>255?255:r}function n(r,n,t,e,a){for(var o,i,u,f,c,s=195076,v=0,p=0;a>p;p++)c=e[p],o=r-c[0],i=n-c[1],u=t-c[2],f=o*o+i*i+u*u,s>f&&(v=p,s=f);return v}function t(t,a,o,i){for(var u,f,c,s,v,p=0,h=0,l=i.length,g=e,y=new Uint8Array(a*o),m=8,d=8,w=0;o>w;w++)for(var A=w%d,z=0;a>z;z++)s=g[z%m][A],u=r(t[p++]+s),f=r(t[p++]+s),c=r(t[p++]+s),v=n(u,f,c,i,l),y[h++]=v;return y}var e=[[1,49,13,61,4,52,16,64],[33,17,45,29,36,20,48,32],[9,57,5,53,12,60,8,56],[41,25,37,21,44,28,40,24],[3,51,15,63,2,50,14,62],[35,19,47,31,34,18,46,30],[11,59,7,55,10,58,6,54],[43,27,39,23,42,26,38,22]];return{Bayer:t}}();self.onmessage=function(r){var n=r.data,t=run(n);postMessage(t)};